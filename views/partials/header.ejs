<nav class="navbar navbar-expand-lg navbar-light bg-warning">
    <a class="navbar-brand"><img src="/images/logos/yellow_flower.png" class="nav-logo" /></a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNavDropdown">
        <ul class="navbar-nav">
            <li class="nav-item active">
                <span style="cursor: pointer;" class="nav-link" onclick="$('#main').load('/home'); activate(this);">Home</span>
            </li>
            <li class="nav-item">
                <span style="cursor: pointer;" class="nav-link" onclick="$('#main').load('about'); activate(this);">About</span>
            </li>
            <li id="loginbtn" class="nav-item for-login">
                <a class="nav-link" href="#loginModal" data-toggle="modal">Login</a
                >
            </li>
            <li id="logoutbtn" class="nav-item for-logout" style="display: none">
                <a class="nav-link" href="#logoutModal" data-toggle="modal"
                    >Logout</a
                >
            </li>
            <li id="newUserBtn" class="nav-item for-login">
                <a class="nav-link" href="#addCustomerModal" data-toggle="modal"
                    >New User</a
                >
            </li>

            <li class="nav-item dropdown">
                <a
                    class="nav-link dropdown-toggle"
                    href="#"
                    id="navbarDropdownMenuLink"
                    data-toggle="dropdown"
                    aria-haspopup="true"
                    aria-expanded="false"
                >
                    Navigate
                </a>
                <div id="navbarDropDown" class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                    <a class="dropdown-item" onclick="$('#main').load('flowers');">Flowers</a
                    >
                    <a
                        id="userDropDown"
                        class="dropdown-item"
                        onclick="$('#main').load('users');"
                        style="display: none"
                        >Users</a
                    >
                    <a
                        id="branchDropDown"
                        class="dropdown-item"
                        onclick="$('#main').load('branches');"
                        >Branches</a
                    >
                </div>
                <li class="nav-item">
                <div id="welcomeNote" class="nav-link fancy" style="font-size: 20px;">
                    Welcome
                </div>
                </li>
            </li>
        </ul>
    </div>
</nav>

<div id="loginModal" class="modal fade">
    <div class="modal-dialog modal-login">
        <div class="modal-content">
            <form action="javascript:void(0);">
                <div class="modal-header">
                    <h4 class="modal-title">Login</h4>
                    <button
                        type="button"
                        class="close"
                        data-dismiss="modal"
                        aria-hidden="true"
                    >
                        &times;
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Email</label>
                        <input
                            type="text"
                            id="email"
                            class="form-control"
                            required="required"
                        />
                    </div>
                    <div class="form-group">
                        <div class="clearfix">
                            <label>Password</label>
                            <a href="#" class="float-right text-muted">
                                <small>Forgot?</small>
                            </a>
                </div>

                <input id="password" type="password" class="form-control" required="required" />
    </div>
    </div>
    <div class="modal-footer justify-content-between">
        <label class="form-check-label">
                        <input type="checkbox" />
                        Remember me
                    </label>
        <button class="btn btn-warning" onclick="get_user()">
                        Login
                    </button>
    </div>
    </form>
    </div>
    </div>
    </div>

    <div id="logoutModal" class="modal fade">
        <div class="modal-dialog modal-login">
            <div class="modal-content">
                <form action="javascript:void(0);">
                    <div class="modal-header">
                        <h4 class="modal-title">Log Out</h4>
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                        &times;
                    </button>
                    </div>
                    <div class="modal-body">Are you sure you want to log out?</div>
                    <div class="modal-footer justify-content-between">
                        <button class="btn btn-warning" onclick="logout()">
                        Yes
                    </button>
                        <button class="btn btn-warning" data-dismiss="modal">
                        No
                    </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div id="addCustomerModal" class="modal fade">
        <div class="modal-dialog modal-login">
            <div class="modal-content">
                <form action="javascript:void(0);">
                    <div class="modal-header">
                        <h4 class="modal-title">New Customer</h4>
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                            &times;
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label>First Name</label>
                            <input type="text" id="fnameAddCustomer" class="form-control" required="required" />
                            <label>Last Name</label>
                            <input type="text" id="lnameAddCustomer" class="form-control" required="required" />
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="text" id="emailAddCustomer" class="form-control" required="required" />
                        </div>
                        <div class="form-group">
                            <label>Password</label>
                            <input id="passwordAddCustomer" type="password" class="form-control" required="required" />
                        </div>
                        <div class="form-group">
                            <label>Confirm Password</label>
                            <input id="passwordAddCustomerConfirm" type="password" class="form-control" required="required" />
                        </div>
                    </div>
                    <div class="modal-footer justify-content-between">
                        <button class="btn btn-warning" onclick="createCustomer()">
                            Create
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <script>
        function isAuthorizedUsers(userType) {
            return (
                userType == "Developer" ||
                userType == "manager" ||
                userType == "employee"
            );

        }

        function get_user() {
            if ($("#email").val() == "" || $("#password").val() == "") return;
            login($("#email").val(), $("#password").val());
        }

        async function login(email, password) {
            fetch("/authenticate", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        email: email,
                        password: password,
                    }),
                })
                .then((res) => res.json())
                .then((data) => {
                    if (data.success) {
                        console.log("Login Successful");
                        $("#loginModal:visible").modal("toggle");
                        $(".for-login").hide();
                        $(".for-logout").show();
                        $("#welcomeNote").text(`Welcome, ${data.user.fname} ${data.user.lname}`);
                        $("#userDropDown").toggle(isAuthorizedUsers(data.user.userType));
                    } else {
                        console.log("Error:", data.message);
                    }
                })
                .catch((error) => {
                    console.error("Failed to connect to server");
                });
        }


        async function logout() {
            fetch("/logout")
                .then((res) => res.json())
                .then((data) => {
                    if (data.success) {
                        console.log("Logout Successful");
                        $("#welcomeNote").text("Welcome");
                        $("#logoutModal").modal("toggle");
                        $(".for-login").show();
                        $(".for-logout").hide();
                        $("#userDropDown").toggle(false);
                        $("#main").load("/home");
                    }
                })
                .catch((error) => {
                    console.error("Failed to connect to server");
                });
        }

        async function checkUser() {
            let fname = getCookie("fname");
            if (fname == null || fname == "") {
                return;
            }
            $(".for-login").hide();
            $(".for-logout").show();
            let lname = getCookie("lname");
            $("#welcomeNote").text(`Welcome, ${fname} ${lname}`);
            let userType = getCookie("userType");
            if (isAuthorizedUsers(userType)) {
                fetch("/userType")
                    .then((res) => res.json())
                    .then((data) => {
                        $("#userDropDown").toggle(data.isAuth);
                        console.log(data);

                    })
                    .catch((error) => {
                        console.error("Failed to connect to server");
                    });

            } else $("#userDropDown").toggle(false);
        }

        function getCookie(name) {
            var nameEQ = name + "=";
            var ca = document.cookie.split(";");
            for (var i = 0; i < ca.length; i++) {
                var c = ca[i];
                while (c.charAt(0) == " ") c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) == 0)
                    return c.substring(nameEQ.length, c.length);
            }
            return null;
        }

        function activate(curElement) {
            $(curElement).parent().siblings().each(function() {
                $(this).removeClass("active")
            });
            $(curElement).parent().addClass("active");
        }
        checkUser();
        async function createCustomer() {
            let password = $(passwordAddCustomer).val();
            if (password != $(passwordAddCustomerConfirm).val()) {
                return;
            }
            let fname = $(fnameAddCustomer).val();
            let lname = $(lnameAddCustomer).val();
            let email = $(emailAddCustomer).val();
            fetch("/createCustomer", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        email: email,
                        password: password,
                        fname: fname,
                        lname: lname
                    }),
                })
                .then((res) => res.json())
                .then((data) => {
                    if (data.success) {
                        $("#addCustomerModal").modal("toggle");
                        $(".form-group input").val('');
                        if (!getCookie("fname")) {
                            login(email, password);
                        }
                    }

                })
                .catch((error) => {
                    console.error("Failed to connect to server");
                });
        }
    </script>